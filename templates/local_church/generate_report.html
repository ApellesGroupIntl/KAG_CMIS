{% extends "base.html" %}
{% load humanize %}

{% block title %}KAG MURANG'A CHURCH - Generate Reports{% endblock %}

{% block page_title %}Generate Reports{% endblock %}

{% block breadcrumb %}
<li class="breadcrumb-item"><a href="{% url 'Local_Church:dashboard' %}">Local Church</a></li>
<li class="breadcrumb-item"><a href="{% url 'Local_Church:report_list' %}">Reports</a></li>
<li class="breadcrumb-item active">Generate</li>
{% endblock %}

{% block content %}
<!-- Messages display -->
{% if messages %}
<div class="row mb-3">
    <div class="col-12">
        {% for message in messages %}
        <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
            <i class="bi {% if message.tags == 'success' %}bi-check-circle-fill{% else %}bi-exclamation-triangle-fill{% endif %} me-2"></i>
            {{ message }}
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
        {% endfor %}
    </div>
</div>
{% endif %}

<div class="row">
    <div class="col-lg-8 mx-auto">
        <!-- Generate Report Card -->
        <div class="card card-action mb-4">
            <div class="card-header bg-primary text-white d-flex align-items-center">
                <h5 class="mb-0"><i class="bi bi-file-earmark-bar-graph me-2"></i> Generate Monthly Report</h5>
            </div>
            <div class="card-body">
                <form method="post" action="{% url 'Local_Church:generate_report' %}">
                    {% csrf_token %}

                    <div class="row g-3">
                        <div class="col-md-6">
                            <label class="form-label">Church <span class="text-danger">*</span></label>
                            <select name="church" class="form-select" required>
                                <option value="">Select Church</option>
                                <option value="Murangá Church" selected>Murangá Church</option>
                                <!-- Add other churches if needed -->
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">Month <span class="text-danger">*</span></label>
                            <select name="month" class="form-select" required>
                                <option value="">Select Month</option>
                                <option value="1">January</option>
                                <option value="2">February</option>
                                <option value="3">March</option>
                                <option value="4">April</option>
                                <option value="5">May</option>
                                <option value="6">June</option>
                                <option value="7">July</option>
                                <option value="8">August</option>
                                <option value="9">September</option>
                                <option value="10">October</option>
                                <option value="11">November</option>
                                <option value="12">December</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">Year <span class="text-danger">*</span></label>
                            <input type="number" name="year" class="form-control" min="2020" max="2030" required>
                        </div>
                        <div class="col-12 mt-4">
                            <button type="submit" class="btn btn-success btn-lg w-100">
                                <i class="bi bi-gear me-2"></i> Generate Report
                            </button>
                        </div>
                    </div>
                </form>
            </div>
        </div>

        <!-- Quick Reports Section -->
        <div class="card card-action">
            <div class="card-header bg-info text-white d-flex align-items-center">
                <h5 class="mb-0"><i class="bi bi-lightning me-2"></i> Quick Reports</h5>
            </div>
            <div class="card-body">
                <div class="row g-3">
                    <div class="col-md-4">
                        <a href="{% url 'Local_Church:generate_report' %}?type=this_month" class="btn btn-outline-primary w-100 h-100 py-3">
                            <div class="d-flex flex-column align-items-center">
                                <i class="bi bi-calendar-month display-6 mb-2"></i>
                                <span>This Month</span>
                                <small class="text-muted">{{ current_month_name }}</small>
                            </div>
                        </a>
                    </div>
                    <div class="col-md-4">
                        <a href="{% url 'Local_Church:generate_report' %}?type=last_month" class="btn btn-outline-secondary w-100 h-100 py-3">
                            <div class="d-flex flex-column align-items-center">
                                <i class="bi bi-calendar-check display-6 mb-2"></i>
                                <span>Last Month</span>
                                <small class="text-muted">{{ last_month_name }}</small>
                            </div>
                        </a>
                    </div>
                    <div class="col-md-4">
                        <a href="{% url 'Local_Church:generate_report' %}?type=this_quarter" class="btn btn-outline-success w-100 h-100 py-3">
                            <div class="d-flex flex-column align-items-center">
                                <i class="bi bi-calendar-range display-6 mb-2"></i>
                                <span>This Quarter</span>
                                <small class="text-muted">Q{{ current_quarter }}</small>
                            </div>
                        </a>
                    </div>
                </div>
            </div>
        </div>

        <!-- Recent Reports Section -->
        {% if recent_reports %}
        <div class="card card-action mt-4">
            <div class="card-header">
                <h5 class="mb-0"><i class="bi bi-clock-history me-2"></i> Recent Reports</h5>
            </div>
            <div class="card-body">
                <div class="list-group">
                    {% for report in recent_reports|slice:":5" %}
                    <a href="{% url 'Local_Church:report_detail' report.pk %}" class="list-group-item list-group-item-action">
                        <div class="d-flex w-100 justify-content-between">
                            <h6 class="mb-1">{{ report.month }} {{ report.year }}</h6>
                            <small class="text-muted">{{ report.generated_on|timesince }} ago</small>
                        </div>
                        <p class="mb-1">{{ report.church_name }}</p>
                        <div class="d-flex justify-content-between">
                            <small class="text-muted">Ksh {{ report.total_givings|default:0|floatformat:2|intcomma }}</small>
                            <span class="badge {% if report.is_approved %}bg-success{% else %}bg-warning{% endif %}">
                                {% if report.is_approved %}Approved{% else %}Pending{% endif %}
                            </span>
                        </div>
                    </a>
                    {% endfor %}
                </div>
            </div>
        </div>
        {% endif %}
    </div>
</div>
{% endblock %}

{% block extra_css %}
<style>
    .card-action {
        border: none;
        border-radius: 12px;
        box-shadow: 0 4px 6px rgba(0,0,0,0.04);
        transition: transform 0.3s ease, box-shadow 0.3s ease;
    }

    .card-action:hover {
        transform: translateY(-3px);
        box-shadow: 0 8px 15px rgba(0,0,0,0.06);
    }

    .list-group-item {
        border-radius: 8px;
        margin-bottom: 8px;
        border: 1px solid #f1f3f4;
        transition: all 0.3s ease;
    }

    .list-group-item:hover {
        background-color: #f8f9fa;
        border-color: #dee2e6;
        transform: translateX(4px);
    }

    .btn-outline-primary, .btn-outline-secondary, .btn-outline-success {
        border-radius: 12px;
        transition: all 0.3s ease;
    }

    .btn-outline-primary:hover, .btn-outline-secondary:hover, .btn-outline-success:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }
</style>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Set current year as default
    const currentYear = new Date().getFullYear();
    const yearInput = document.querySelector('input[name="year"]');
    if (yearInput && !yearInput.value) {
        yearInput.value = currentYear;
    }

    // Set current month as default
    const currentMonth = new Date().getMonth() + 1;
    const monthSelect = document.querySelector('select[name="month"]');
    if (monthSelect) {
        // Only set if no value is selected and it's not the quick report links
        if (!monthSelect.value && !window.location.search.includes('type=')) {
            monthSelect.value = currentMonth;
        }
    }

    // Add form validation
    const form = document.querySelector('form');
    if (form) {
        form.addEventListener('submit', function(e) {
            const church = document.querySelector('select[name="church"]');
            const month = document.querySelector('select[name="month"]');
            const year = document.querySelector('input[name="year"]');

            if (!church.value) {
                e.preventDefault();
                alert('Please select a church');
                church.focus();
                return false;
            }

            if (!month.value) {
                e.preventDefault();
                alert('Please select a month');
                month.focus();
                return false;
            }

            if (!year.value) {
                e.preventDefault();
                alert('Please enter a year');
                year.focus();
                return false;
            }
        });
    }

    // Check if we have a success message in URL parameters
    const urlParams = new URLSearchParams(window.location.search);
    if (urlParams.get('success') === 'true') {
        // Show success message
        const alertDiv = document.createElement('div');
        alertDiv.className = 'alert alert-success alert-dismissible fade show';
        alertDiv.innerHTML = `
            <i class="bi bi-check-circle-fill me-2"></i>
            Report generated successfully!
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        `;
        document.querySelector('.row').prepend(alertDiv);

        // Clean up URL
        window.history.replaceState({}, document.title, window.location.pathname);
    }

    // Check for error messages
    if (urlParams.get('error')) {
        // Show error message
        const alertDiv = document.createElement('div');
        alertDiv.className = 'alert alert-danger alert-dismissible fade show';
        alertDiv.innerHTML = `
            <i class="bi bi-exclamation-triangle-fill me-2"></i>
            There was a problem generating the report. Please try again.
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        `;
        document.querySelector('.row').prepend(alertDiv);

        window.history.replaceState({}, document.title, window.location.pathname);
    }
});
</script>
{% endblock %}